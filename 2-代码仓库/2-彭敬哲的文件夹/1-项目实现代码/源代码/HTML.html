<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频转MIDI</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <h1>音频转MIDI</h1>
    <h3>当前时间：</h3>
    <p id="currentTime"></p>
    <!-- 显示上传和转换状态 -->
    <div id="status">
        <!-- 上传音频文件的表单 -->
        <a href="/ismir2021_note">获取纯音乐NoteSequence</a>
        <form id="uploadForm" enctype="multipart/form-data">
            <label for="audioFile">选择音频文件：</label>
            <input type="file" id="audioFile" name="file" accept=".wav, .mp3">
            <button type="button" onclick="uploadAudio('/mt3')">上传混合音频</button>
            <button type="button" onclick="uploadAudio('/ismir2021')">上传纯音乐音频</button>
        </form>
    </div>
    <!-- 显示上传进度 -->
    <progress id="uploadProgress" value="0" max="100">上传ing</progress>
    <p id="convering" style="display:none">转化ing</p>
    <!-- 下载生成的MIDI文件按钮 -->
    <button id="downloadButton1" onclick="download_mt3()" style="display:none">下载MIDI文件</button>
    <button id="downloadButton2" onclick="download_ismir2021()" style="display:none">下载MIDI文件</button>
    
    <script>
        // 全局变量存储服务器 IP 地址
        var serverIp = 'https://instantly-stirred-gnat.ngrok-free.app'; // 替换为你的服务器 IP 和端口

        function updateCurrentTime() {
            var currentTimeElement = document.getElementById('currentTime');

            // 创建一个 Date 对象来获取当前时间
            var currentTime = new Date();

            // 格式化时间字符串
            var formattedTime = currentTime.toLocaleTimeString();

            // 更新页面上显示的时间
            currentTimeElement.textContent = formattedTime;
        }

        // 初始加载时获取当前时间
        updateCurrentTime();
        // 每隔一秒更新一次时间
        setInterval(updateCurrentTime, 1000);

        // 上传音频文件的函数
        function uploadAudio(model_url) {
            var form = document.getElementById('uploadForm');
            var formData = new FormData(form);

            // 创建 XMLHttpRequest 对象
            var xhr = new XMLHttpRequest();

            // 监听上传进度事件
            xhr.upload.addEventListener('progress', function (event) {
                if (event.lengthComputable) {
                    var percentComplete = (event.loaded / event.total) * 100;
                    document.getElementById('uploadProgress').value = percentComplete;
                    if (percentComplete == 100) {
                        document.getElementById('convering').style.display = 'block';
                    }
                }
            });

            // 发送POST请求到服务器
            xhr.open('POST', serverIp + model_url, true);
            xhr.send(formData);

            // 处理服务器响应
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);

                        // 显示上传和转换状态
                        document.getElementById('status').innerHTML = data.message;

                        // 如果转换成功，显示下载按钮
                        if (data.success) {
                            if (model_url == '/mt3') {
                                document.getElementById('downloadButton1').style.display = 'block';
                            } else {
                                document.getElementById('downloadButton2').style.display = 'block';
                            }
                            document.getElementById('convering').style.display = 'none';
                        }
                    } else {
                        console.error('Error:', xhr.status);
                    }
                }
            };
        }

        // 下载MIDI文件的函数
        function download_mt3() {
            // 创建一个虚拟的a标签，模拟点击下载
            var link = document.createElement('a');
            link.href = serverIp + '/mt3/download'; // 这里填写下载的路由
            link.download = 'output.mid'; // 这里填写默认的下载文件名
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 下载MIDI文件的函数
        function download_ismir2021() {
            // 创建一个虚拟的a标签，模拟点击下载
            var link = document.createElement('a');
            link.href = serverIp + '/ismir2021/download'; // 这里填写下载的路由
            link.download = 'output.mid'; // 这里填写默认的下载文件名
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 检查用户不活跃状态并发送请求
        setInterval(function () {
            var currentTime = new Date().getTime();
            var inactiveTime = currentTime - lastActivityTime;

            // 如果用户不活跃超过一定时间，发送请求
            if (inactiveTime > 60000) { // 60秒不活跃
                $.ajax({
                    url: serverIp + '/inactive',
                    type: 'GET',
                    success: function (response) {
                        console.log(response);
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            }
        }, 10000); // 10秒检查一次，你可以根据需要调整间隔时间
    </script>
</body>

</html>
